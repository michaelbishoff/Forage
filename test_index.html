<html class="no-js" lang="en">
    <head>
      <meta charset="utf-8" />
      <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
      <title>Forage!</title>
      <link rel="stylesheet" href="css/foundation.css" />
      <link rel="stylesheet" href="css/override.css" />
      <link href='http://fonts.googleapis.com/css?family=Lato' rel='stylesheet' type='text/css'>
      <script type="text/javascript" src="http://www.parsecdn.com/js/parse-1.3.0.min.js"></script>
      <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
      <script src="js/vendor/modernizr.js"></script>
      <link rel="stylesheet" href="css/foodmap.css" />
      <script src="https://maps.googleapis.com/maps/api/js?v=3.exp"></script>
      <script src="foodMarker.js"></script>
    </head>
    <body onload="getMessages()">
   <!-- Top slide -->
   <!-- Large logo will only display on larger screens -->
   <div class="home hide-for-small">
    <img src="img/logo.png" />
  </div>

  <div class="home show-for-small"><br>
    <img src="img/logo2.png"><br />
  </div> 

  <a href="#map-canvas"><button id="big-button"><img style="margin-top:-6px" src="img/arrow.png"></h4>
  </button></a>

  <script>
    $(function() {
      $('a[href*=#]:not([href=#])').click(function() {
        if (location.pathname.replace(/^\//,'') == this.pathname.replace(/^\//,'') && location.hostname == this.hostname) {
          var target = $(this.hash);
          target = target.length ? target : $('[name=' + this.hash.slice(1) +']');
          if (target.length) {
            $('html,body').animate({
              scrollTop: target.offset().top
            }, 1000);
            return false;
          }
        }
      });
    });
      </script>

      <!--<div id="">
      <input id="address" type="textbox" value="Massachusetts, USA">
      <input type="button" value="Geocode" onclick="codeAddress()">
      </div>-->
      <div class="map" id="map-canvas"></div>
        
        <br />
        
      <div class="row">
        <div class="large-12 medium-12 text-center columns">  
        <form>
            <h4>Choose a foodlocker above and tell us what food you're dropping off.</h4> 
            <input class="small radius" type="text" id="foodItem" /><br />
            <h4>Include information about dietary restrictions. </h4><br />
            <input type="checkbox" id="alergens[]" name="alergens1" value="Nuts">Nuts</input>
            <input type="checkbox" id="alergens[]" name="alergens2" value="Pork">Pork</input>
            <input type="checkbox" id="alergens[]" name="alergens3" value="Milk">Milk</input><br />
            <input class=" button radius" type="button" id="submitButton" value="Submit" />
        </form>
        </div>
      </div>
        <br />
        
        <div id="display">
            <div id="messages">

            </div>
        </div>

        <div>
            <form>
                <input type="button" id="clearButton" value="Clear" />
            </form>
        </div>
        
        <script src="js/vendor/jquery.js"></script>
        <script src="js/foundation.min.js"></script>
        <script>
          $(document).foundation();
        </script>
        <script type="text/javascript" src="setup.js"></script>
        <script type="text/javascript">

            /*
            var TestObject = Parse.Object.extend("TestObject");
            var testObject = new TestObject();
            testObject.save({foo: "bar"}).then(function(object) {
              alert("yay! it worked");
            });
            */
            
            var getMessages = function() {
                var q = new Parse.Query("Message");
                q.limit(10);
                q.descending("createdAt");
                q.find().then(function(messages) {
//                    messages.reverse();
                    displayMessages(messages);
                });
            };

            var saveMessage = function(foodItem, alergens, address){
                var message = new Parse.Object("Message");
                message.set("foodItem", foodItem);
                message.set("alergens", alergens);
                message.set("address", address);
                message.save().then(function() {
//                    alert("Added " + foodItem + " which contains: " + alergens + " at " + address);
                }, function(err){
                    alert("Error");
                    console.log(err);
                });
            }
            
            var displayMessages = function(messages) {
                var messagesDiv = $("#messages");
                messagesDiv.hide().empty().remove();
                $.each(messages, function(_, message) {
                    var foodItemClass = "foodItem";

                    // Simple and straightforward, but suboptimal
                    var row = [ "<p><span class='", foodItemClass, "'>",
                                " [",
                                message.createdAt.getHours(),
                                ":",
                                message.createdAt.getMinutes(),
                                "] ",
                                message.get("foodItem"),
                                " contains ",
                                message.get("alergens"),
                                " at ",
                                message.get("address"),
                                "</span></p>" ].join("");
                    messagesDiv.append(row);
                  });
                  $("#display").append(messagesDiv);
                  messagesDiv.fadeIn();
            };
            
            

            // Attach handler to the "Send" button
            $("#submitButton").click(function() {
              // Pull the values out of the HTML inputs
              var foodItem = $("#foodItem").val();
                
              var alergens = "";
              var alergens_array = $(':checked').map(function(i,n) {
                  return $(n).val();
              }).get(); //get
                
                
              if (alergens_array.length == 1){
                  alergens += alergens_array[0];
              }
              else {
                  for (i = 0; i < alergens_array.length; i++){
                      if (i == alergens_array.length - 1){
                          alergens += alergens_array[i];
                      }
                      else {
                          alergens += alergens_array[i] + ", ";
                      }
                  }
              }
              
              var address = $("#address").val();
              if (foodItem.length === 0) {
                return false;
              }
              
              // Take those values and actually save the message
              saveMessage(foodItem, alergens, address);
                
              // Clean up after ourselves - reset our input and reload the chat
              $(':checked').each(function() {
                  $(this).prop("checked", false);
              });
                
              $("#foodItem").val("");
              $("#address").val("");
                
              getMessages();
            });
            
            $("clearButton").click(function() {
                
            });
            
            /*
            $("clearButton").click(function() {
                var q = new Parse.Query("Message");
                q.descending("createdAt");
                q.find().then(function(messages) {
                    
                    messages.destroy({
                    success: function(myObject) {
                      // The object was deleted from the Parse Cloud.
                    },
                    error: function(myObject, error) {
                      // The delete failed.
                      // error is a Parse.Error with an error code and message.
                    }
                    });
//                    messages.reverse();
//                    displayMessages(messages);
                });
            }
            */
            
        
/*
// IMPLEMENT ME:
// 
// Use a Parse Query to get objects of type "Message". Start off with a limit
// of 10 items, then experiment with Query conditions to grab different
// messages other folks have created.
//
// Documentation: https://parse.com/docs/js_guide#queries-basic
var getMessages = function() {
  var q = new Parse.Query("Message");
  q.limit(10);
  q.descending("createdAt");
  q.find().then(function(messages) {
    messages.reverse();
    displayMessages(messages);
  });

  // We've defined a success handler for you! After you've constructed your
  // query, pass it `displayMessages` (defined in setup.js) to handle the
  // rendering of the messages.
};

// IMPLEMENT ME:
// 
// Create a new Parse Object (with "Message" as the class name) and use the
// "username" and "messageBody" parameters to save an object.
//
// Documentation: https://parse.com/docs/js_guide#objects
var saveMessage = function(username, messageBody) {
  var m = new Parse.Object("Message");
  m.set("username", username);
  m.set("body", messageBody);
  m.save().then(function() {
    getMessages();
  }, function(err) {
    console.log(err);
  });

  // Note that our .save() function is asynchronous! Instead of passing it a
  // callback directly, here's how you'd use a Promise to attach behavior on
  // success or failure:
  //
  // object.save().then(
  //   function(object) {
  //     console.log("Saved!");
  //     console.log(object);
  //   }, function(error) {
  //     console.log("Error!");
  //     console.log(error);
  //   });
  //
  // (Read more: http://blog.parse.com/2013/01/29/whats-so-great-about-javascript-promises/))
};

// Attach handler to the "Send" button
$("#send_button").click(function() {
  // Pull the values out of the HTML inputs
  var username = $("#username").val();
  var messageBody = $("#message").val();
  var color = $("#colors").val();
  if (messageBody.length === 0) {
    return false;
  }

  // Take those values and actually save the message
  saveMessage(username, messageBody);

  // Clean up after ourselves - reset our input and reload the chat
  $("#message").val("");
  getMessages();
});


// Attach handler to "Reload" link
$("#reload").click(getMessages);
// Get messages on load
getMessages();
*/        
        
        
        
        </script>
    </body>
</html>